<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML Basic 1.1//EN" 
	"http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd">
<html xml:lang="fr" lang="fr" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
<meta name='generator' content='SPIP 2.1.26' />
<meta name='language' content='fr' />
<meta name='description' content='PACS 2013 2014' />
<link rel='stylesheet' type='text/css' media='all'
	href='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?page=config-placement.css' />
<link rel='stylesheet' type='text/css' media='screen, projection' 
	href='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?page=config.css&amp;spec=Licence' />
<link rel='stylesheet' type='text/css'  media='print'
	href='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/extensions/DidacSPIP/css/impression.css' />
<link rel='stylesheet' type='text/css' 
	media='handheld, only screen and (max-device-width: 480px)'
	href='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/extensions/DidacSPIP/css/handheld.css' />
<link rel="alternate"
	type="application/rss+xml"
	title="Syndiquer cette rubrique"
	href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/?page=backend&amp;id_rubrique[]=1&amp;id_rubrique[]=435"
/><link rel="search" type="application/opensearchdescription+xml" 
	href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?page=opensearch.xml"
	title="PACS 2013 2014" />
<script type='text/javascript' src='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/extensions/DidacSPIP/prive/javascript/admin_check.js'></script>
<title>10. Formulaires en AJAX (PACS 2013 2014)</title>
</head><body class="default-parameters">
<div id="navigation-upmc">
	<div class="menu-lv1">
		<a class='menu-logo' href='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/ecrire/'
			title='Espace priv&eacute;'>Espace priv&eacute;</a>
	</div>
	<div class="menu-lv1"><a href="http://www.upmc.fr" title="Universit&eacute; Pierre et Marie Curie">UPMC</a></div>
	<div class='menu-lv1 fs80'><a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev" title="Accueil du site">PACS 2013 2014</a></div>
	<div class="menu-lv1">
	<a href='pacs' title="Programmation des Architectures Clients-serveur">pacs</a>
</div>


<div class="menu-lv1">Navigation dans la page</div><ul class="menu-lv1">
<li class="menu-lv2"><a href='#a1'>Ajax</a></li>
<li class="menu-lv2"><a href='#a2'>Première requête asynchrone</a></li>
<li class="menu-lv2"><a href='#a3'>Réponse hors HTML</a></li>
<li class="menu-lv2"><a href='#a4'>Présenter les noms</a></li>
<li class="menu-lv2"><a href='#a5'>Réception d&#8217;un groupe</a></li>
<li class="menu-lv2"><a href='#a6'>Vérification des notes</a></li>
<li class="menu-lv2"><a href='#a7'>Enregistrer les notes</a></li>
<li class="menu-lv2"><a href='#a8'>Affichage de la moyenne</a></li>
<li class="menu-lv2"><a href='#a9'>Annexes</a></li>
</ul>


<div class="menu-lv1"><form id="formulaire_recherche" action="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?page=recherche" method="get"><div>
<input name="page" value="recherche" type="hidden" />
<a href='.'
	onclick='addSearchProvider("https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?page=opensearch.xml");return false'
	title='Utiliser le moteur de recherche OpenSearch'>O</a>
<label for='recherche' style='display:none'>Rechercher</label>
<input type="text" name="recherche" id='recherche' value="Rechercher" />
</div></form>
</div>	<div class="menu-lv1-last">&nbsp;</div>
</div><div id="content">

<h1>pacs&nbsp;: Travaux Dirig&eacute;s<br />10. Formulaires en AJAX</h1>
<p>Le but de cette séance est d&#8217;utiliser les possibilités de requêtes HTTP asynchrones permises par JavaScript et son objet <tt>XMLHttpRequest</tt> pour améliore considérablement l&#8217;ergonomie des formulaires Web. On reprend ici l&#8217;application de saisies de notes à double script vue à la séance <a href="Le-temps-du-formulaire" class='spip_in'>Le temps du formulaire</a>, dont la partie PHP va se retrouver fortement allégée,  un fichier HTML initial , fourni en annexe, contenant dès le départ les deux formulaires,  le deuxième étant initialement caché grâce à la propriété <tt>display</tt> des CSS.</p>
<br /><div id='sequence435'>
<span id='e3586'></span>


<h2 id='a1'>1 Ajax</h2>
<p>Redonner la <a href="Securite-et-Concurrence-sur-le-Web#(32)" class='spip_in'>fonction Javascript AJAX expliquée en cours</a>, implémentant les requêtes asynchrones et rappeler le rôle de ses paramètres.</p>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=837&amp;cle=d6842d5b77bd92b7108265cb776eebfb32cca2f8&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fajax.js"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger ajax.js</a>
</div>
<pre>// Fonction d'envoi de requetes asynchrones:
// url: ressource sur le serveur courant, avec query-string eventuelle
// flux: flux d'entree en cas de methode POST
// rappel: fonction a appliquer sur l'objet Ajax lorsque le serveur repond
// method: methode HTTP (GET par defaut)
function ajax(url, flux, rappel, method) {
  var r = window.XMLHttpRequest ? new XMLHttpRequest() :
    (window.ActiveXObject ?  new ActiveXObject("Microsoft.XMLHTTP") : '');
  if (!r) return false;
  r.onreadystatechange = function () {rappel(r);}
  r.open(method ? method : 'GET', url, true);
  if (flux)
      r.setRequestHeader("Content-Type", 
                         "application/x-www-form-urlencoded; ");
  r.send(flux);
  return true;
}
</pre></div>


<span id='e3587'></span>


<h2 id='a2'>2 Première requête asynchrone</h2>
<p>La fonction JavaScript <tt>groupe_td10</tt> est appelée lorsque l&#8217;utilisateur introduit un numéro de groupe dans la balise de saisie du premier formulaire de la page fournie en annexe. Elle reçoit en argument ce formulaire sous sa forme abstraite, qui  comporte toujours un champ <tt>elements</tt>, tableau des balises de saisies, ici réduites à une seule, de nom <tt>groupe</tt>. A l&#8217;aide d&#8217;une expression rationnelle, vérifier que la saisie fournie est un nombre entier. Construire ensuite une URL demandant l&#8217;exécution d&#8217;un script <tt>get_groupe.php</tt> avec une Query-String réduite au paramètre <tt>groupe</tt>, de valeur la saisie fournie (ou 0 si elle était incorrecte). La fonction de rappel à donner se nomme <tt>verifier_td10</tt> et sera définie à la question 5.</p>

<p>Si le numéro de groupe saisi est correct, s&#8217;affichera ultérieurement la moyenne des notes du groupe. La présente fonction doit à l&#8217;inverse rendre invisible la moyenne du groupe saisi précédemment, aussi la balise <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/global.html#edef-SPAN" class='spip_glossaire' title="html" rel='external'>span</a> dans le premier formulaire doit avoir sa propriété  CSS <tt>display</tt> à <tt>none</tt> juste avant d&#8217;envoyer cette requête.</p>

<p>De même,  le deuxième formulaire ne doit pas apparaître à ce stade. Là il ne s&#8217;agit pas seulement de le rendre invisible, mais également de le vider de son contenu puisque la liste des étudiants changera. Cette liste est ébauchée dans le fichier HTML sous forme d&#8217;une balise <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/lists.html#edef-UL" class='spip_glossaire' title="html" rel='external'>ul</a>. 
Repérer l&#8217;attribut <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/global.html#adef-id" class='spip_glossaire' title="html" rel='external'>id</a> de cette balise, et remettre son contenu à vide  à l&#8217;aide la méthode <tt>innerHTML</tt>.</p>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=839&amp;cle=035f22038bbd390065f19d7ab6ddbbeab5926884&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fgroupe.js"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger groupe.js</a>
</div>
<pre>function groupe_td10 (form) {
    document.getElementById('u').innerHTML = '';
    document.getElementById('moyenne').style.display = 'none';
    var v = form.elements['groupe'].value;
    // construire une Query-string SECURISEE (un nombre, rien d'autre)
    if (!/^[0-9]+$/.test(v)) v = 0;
    ajax('get_groupe.php?groupe=' + v, '', verifier_td10);
    return false;
}
</pre></div>


<span id='e3588'></span>


<h2 id='a3'>3 Réponse hors HTML</h2>
<p>Le script <tt>get_groupe.php</tt> est censé recevoir dans sa Query-String un paramètre nommé <tt>groupe</tt> ayant pour valeur un entier. On suppose que ce script représente la liste des groupes sous la forme d&#8217;un tableau PHP indexé par les numéros des groupes, et dont les valeurs sont des sous-tableaux formés des noms des étudiants.</p>

<p>Si le paramètre <tt>groupe</tt> est absent ou n&#8217;est pas un index du tableau, le script renvoie le code de retour HTTP <tt>204 No Content</tt>, à l&#8217;aide la fonction <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/PHP/html/function.header.html" class='spip_glossaire' title="php" rel='external'>header</a>. Autrement, il renvoie un contenu de type  <tt>text/plain</tt>, composé de la suite des noms séparés par un 
";"  avec un ";" terminal.</p>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=838&amp;cle=c8571530257a655ba499c31145ea8f7b96269106&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fget_groupe.php"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger get_groupe.php</a>
</div>
<p><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$groupes&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">1&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'a'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'b'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'c'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">2&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'d'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'e'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'f'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'g'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">3&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'h'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'i'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">4&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'j'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'k'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'l'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><br />if&nbsp;(!isset(</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'groupe'</span><span style="color: #007700">])&nbsp;||&nbsp;!isset(</span><span style="color: #0000BB">$groupes</span><span style="color: #007700">[</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'groupe'</span><span style="color: #007700">]]))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">header</span><span style="color: #007700">(</span><span style="color: #DD0000">"HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content"</span><span style="color: #007700">);<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">header</span><span style="color: #007700">(</span><span style="color: #DD0000">'Content-Type:&nbsp;text/plain'</span><span style="color: #007700">);<br />&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">join</span><span style="color: #007700">(</span><span style="color: #DD0000">";"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$groupes</span><span style="color: #007700">[</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'groupe'</span><span style="color: #007700">]])&nbsp;.&nbsp;</span><span style="color: #DD0000">';'</span><span style="color: #007700">;<br />}</span>
</span>
</code></p></div>


<span id='e3590'></span>


<h2 id='a4'>4 Présenter les noms</h2>
<p>Le script PHP  précédent renvoyant une simple chaîne de caractères formée de noms séparés par des  ";", il faut transformer celle-ci en une suite de balises <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/lists.html#edef-LI" class='spip_glossaire' title="html" rel='external'>li</a>, chacune composée d&#8217;un <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/interact/forms.html#edef-LABEL" class='spip_glossaire' title="html" rel='external'>label</a> comportant ce nom, suivi d&#8217;une balise <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/interact/forms.html#edef-INPUT" class='spip_glossaire' title="html" rel='external'>input</a>. L&#8217;attribut <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/types.html#type-name" class='spip_glossaire' title="html" rel='external'>name</a> de celle-ci sera égal à "<tt>n</tt>[<i>nom</i>]", où <i>nom</i> est celui considéré. Pour améliorer la présentation, on aura également un attribut <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/present/styles.html#adef-style" class='spip_glossaire' title="html" rel='external'>style</a> de valeur <tt>margin:0.5em</tt>.</p>

<p>Ecrire une fonction  JavaScript <tt>presente_tableau</tt>, recevant en argument une chaîne telle que fournie par le script PHP précédent, ainsi qu&#8217;un objet UL du DOM.&nbsp;Le rôle de cette fonction est de remplir cet objet UL avec les balises <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/lists.html#edef-LI" class='spip_glossaire' title="html" rel='external'>li</a> ci-dessus décrites. Agissant par modification de son 2e argument, cette fonction n&#8217;a pas besoin de retourner de valeur. On utilisera évidemment les fonctions 
<tt>appendChild</tt>,
<tt>createTextNode</tt>,
<tt>createElement</tt> et
<tt>setAttribute</tt> sur les objets appropriés.</p>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=841&amp;cle=c65229a86a2993b77dace66364e7f7db4ce67c93&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fpresenter.js"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger presenter.js</a>
</div>
<pre>function presente_tableau(suite, ul) {
    var r,c,l,i,k;
    k = 0;
    while (r = /^([^;]+);?(.*)$/.exec(suite)) {
	k++;
	c = document.createElement('li');
	l = document.createElement('label');
	l.setAttribute('for', 'id' + k);
	l.appendChild(document.createTextNode(r[1]));
	c.appendChild(l)
	i = document.createElement('input');
	i.style = 'margin: 0.5em';
	i.name = 'n[' + r[1] + ']';
	i.id = 'id' + k; // un ID ne peut contenir '[', donc ici id!=name
	c.appendChild(i);
	ul.appendChild(c);
	suite = r[2];
    }
}
</pre></div>


<span id='e3589'></span>


<h2 id='a5'>5 Réception d&#8217;un groupe</h2>
<p>La fonction <tt>vérifier_td10</tt> est appelée lorsque le serveur répond, et reçoit en argument l&#8217;objet XMLHttpRequest ayant lancé la requête asynchrone. Lorsque son champ <tt>readyState</tt> atteint la valeur 4, la réponse est prête dans le champ <tt>responseText</tt>, et le code de retour  à 3 chiffres est dans le champ <tt>status</tt>. Trois cas peuvent se produire pour ce champ&nbsp;:</p>

<ul class="spip"><li> s&#8217;il vaut 204, le numéro de groupe n&#8217;était pas recevable. Il est alors demandé de réécrire en rouge le label de la balise de saisie fautive. On rajoutera également le mot <tt>Erreur</tt> dans le titre du document (donc de la fenêtre)&nbsp;;</li><li> autrement s&#8217;il ne vaut pas non plus 200, c&#8217;est une erreur de programmation, et on le dira dans une fenêtre d&#8217;alerte&nbsp;;</li><li> s&#8217;il vaut 200, on réalisera les opérations suivantes&nbsp;:<ul class="spip"><li> réécrire en vert  le label de la balise de saisie&nbsp;;</li><li> supprimer le mot <tt>Erreur</tt> dans le titre du document si un appel précédent l&#8217;y avait mis&nbsp;;</li><li> chercher la balise <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/lists.html#edef-UL" class='spip_glossaire' title="html" rel='external'>ul</a>&nbsp;présente dans le 2e formulaire et  appliquer dessus et sur la réponse du serveur  la fonction <tt>presente_tableau</tt>&nbsp;;</li><li> rendre visible le 2e formulaire&nbsp;;</li><li> donner le focus à la première balise de saisie de ce formulaire (ce qui n&#8217;est possible qu&#8217;après l&#8217;avoir rendu visible).</li></ul></li></ul>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=842&amp;cle=9ca2a67e88960e84aaa3fa4f7147f7b5bc813fee&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fverifier.js"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger verifier.js</a>
</div>
<pre>function verifier_td10(xhr) {
    var r;
    if ( xhr.readyState == 4 ) {
	  if (xhr.status == 204) {
	      document.getElementById('label-groupe').style.color = 'red';
	      document.title += ' Erreur';
	  } else if (xhr.status == 200) {
	      document.getElementById('label-groupe').style.color = 'green';
	      r = /^(.*) Erreur$/.exec(document.title);
	      if (r) document.title = r[1];
	      r = document.getElementById('u');
	      presente_tableau(xhr.responseText, r);
	      document.getElementById('f2').style.display = 'block';	      
	      // On ne peut donner le focus que si display != none
	      u.firstChild.firstChild.nextSibling.focus();
	  } else { alert('status ' + xhr.status);}
      }
}
</pre></div>


<span id='e3591'></span>


<h2 id='a6'>6 Vérification des notes</h2>
<p>La fonction JavaScript <tt>notes</tt> est appelée pour vérification des saisies avant envoi du 2e formulaire. Comme pour la fonction <tt>groupe_td10</tt> du premier formulaire, elle reçoit la forme abstraite du 2e formulaire,  avec son champ <tt>elements</tt> comportant toutes les balises de saisies. Le rôle de cette fonction est de contrôler que toutes les saisies effectuées par l&#8217;utilisateur, autrement dit les <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/interact/forms.html#edef-INPUT" class='spip_glossaire' title="html" rel='external'>input</a> de <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/links.html#adef-type-A" class='spip_glossaire' title="html" rel='external'>type</a> <tt>text</tt> (et non <tt>submit</tt>), ont pour valeur un nombre entre 0 et 20, avec éventuellement les décimales 25 ou 50 ou 75 sauf pour 20. Pour toutes les saisies incorrectes, on retracera en rouge la bordure de sa balise <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/interact/forms.html#edef-INPUT" class='spip_glossaire' title="html" rel='external'>input</a>. Pour les autres, on les retracera en noir (leur couleur initiale, mais qui a peut-être changé lors d&#8217;une précédente vérification).</p>

<p>Ecrire la fonction  JavaScript <tt>notes</tt> réalisant ces contrôles. Si toutes les saisies sont correctes,  elle construit de plus une Query-String, formée des couples nom / valeur rencontrés, et appelle par une requête GET asynchrone le script <tt>entrer_notes.php</tt> avec cette Query-String. La fonction de rappel est nommée <tt>moyenne</tt> et sera définie plus loin. Dans tous les cas la fonction  <tt>notes</tt> retourne <tt>False</tt> pour empêcher l&#8217;envoi du formulaire en mode  synchrone.</p>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=840&amp;cle=258dea8c7d83fbf54d44e274b4acab95790b664e&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fnotes.js"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger notes.js</a>
</div>
<pre>function notes (form) {
    var t = true;
    var qs = '';
    for (var e in form.elements) {
	var i = form.elements[e];
	if ((i.tagName == 'INPUT') &amp;&amp; i.type == 'text') {
	    if (!/^(20|[01]?[1-9](|.25|.50|.75))$/.test(i.value)) {
		i.style.border = '2px solid red';
		t = false;   
	    } else {
		i.style.border = '1px solid black';
		if (t)
		    qs += i.name + '=' + i.value + "&amp;";
	    }
	}
    }
    if (t) ajax('entrer_notes.php?' + qs, '', moyenne);
    return false;
}
</pre></div>


<span id='e3592'></span>


<h2 id='a7'>7 Enregistrer les notes</h2>
<p>Le script <tt>entrer_notes.php</tt> écrit dans un fichier quelconque les notes reçues dans le paramètre <tt>n</tt> de la Query-String, paramètre dont la valeur est en fait un tableau (on se contentera ici d&#8217;utiliser <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/PHP/html/function.var-export.html" class='spip_glossaire' title="php" rel='external'>var_export</a>, qui retourne la représentation d&#8217;un tableau PHP). 
Si ce paramètre est vide ou absent, le script retourne simplement 0. Autrement, il retourne la moyenne de ces notes, calculée à l&#8217;aide de la fonction <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/PHP/html/function.array-sum.html" class='spip_glossaire' title="php" rel='external'>array_sum</a>. Dans tous les cas, le type de contenu retourné sera <tt>text/plain</tt>.</p>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=847&amp;cle=8ae02f0cad24781c151062320f6a94ab049194bf&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fentrer_notes.php"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger entrer_notes.php</a>
</div>
<p><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />header</span><span style="color: #007700">(</span><span style="color: #DD0000">'text/plain'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$n&nbsp;</span><span style="color: #007700">=&nbsp;isset(</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'n'</span><span style="color: #007700">])&nbsp;?&nbsp;</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'n'</span><span style="color: #007700">]&nbsp;:&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />if&nbsp;(!</span><span style="color: #0000BB">$n&nbsp;</span><span style="color: #007700">OR&nbsp;!</span><span style="color: #0000BB">is_array</span><span style="color: #007700">(</span><span style="color: #0000BB">$n</span><span style="color: #007700">))<br />&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />else&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$d&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'/tmp/td10.log'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'w'</span><span style="color: #007700">);<br />&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$d</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">var_export</span><span style="color: #007700">(</span><span style="color: #0000BB">$n</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">));<br />&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$d</span><span style="color: #007700">);<br />&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">array_sum</span><span style="color: #007700">(</span><span style="color: #0000BB">$n</span><span style="color: #007700">)&nbsp;/&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$n</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;<br /></span>
</span>
</code></p></div>


<span id='e3593'></span>


<h2 id='a8'>8 Affichage de la moyenne</h2>
<p>La fonction JavaScript <tt>moyenne</tt> est appelée lorsque le serveur répond. Comme pour la fonction <tt>vérifier_td10</tt>, elle reçoit en argument l&#8217;objet XMLHttpRequest, et n&#8217;a quelque chose à faire qu&#8217;à partir du moment où le champ <tt>readyState</tt> passe à 4. Son rôle est d&#8217;afficher la moyenne reçue dans la balise <a href="http://www-ari.ufr-info-p6.jussieu.fr/OUTILS/documentation/doc/html4/struct/global.html#edef-SPAN" class='spip_glossaire' title="html" rel='external'>span</a> prévue à cet effet, et de la rendre visible.  A l&#8217;inverse, elle doit rendre invisible le 2e formulaire, à présent inutile, et réécrire en noir le label du premier formulaire, afin de retrouver la présentation initiale de la page.</p>


<div class='solution'>
<div>Solution
<a href="https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=845&amp;cle=bafedef137fdda8fd9555318c6fcadcf91434742&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fmoyenne.js"
      style='float:right'
      class='solution'>T&eacute;l&eacute;charger moyenne.js</a>
</div>
<pre>function moyenne(xhr) {
    if (xhr.readyState == 4) {
	var r = document.getElementById('moyenne');
	r.replaceChild(document.createTextNode('Moyenne : ' + xhr.responseText),
		       r.firstChild);
	r.style.display = 'block';	
	document.getElementById('label-groupe').style.color = 'black';
	document.getElementById('f2').style.display = 'none';
    }
}
</pre></div>


<span id='e3594'></span>

<h2 id='a9'>9 Annexes</h2>
<div class='spip_code'><pre>&lt;!DOCTYPE html PUBLIC '-//W3C//DTD XHTML Basic 1.1//EN'
	'http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd'&gt;
&lt;html xmlns='http://www.w3.org/1999/xhtml' lang='fr'&gt;
&lt;head&gt;
&lt;meta http-equiv='Content-Type' content='text/html;charset=utf-8' /&gt;
&lt;title&gt;TD10&lt;/title&gt;
&lt;script type='text/javascript' src='ajax.js' &gt;&lt;/script&gt;
&lt;script type='text/javascript' src='groupe.js' &gt;&lt;/script&gt;
&lt;script type='text/javascript' src='verifier.js' &gt;&lt;/script&gt;
&lt;script type='text/javascript' src='presenter.js' &gt;&lt;/script&gt;
&lt;script type='text/javascript' src='notes.js' &gt;&lt;/script&gt;
&lt;script type='text/javascript' src='moyenne.js' &gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;form action="" onsubmit='return groupe_td10(this)'&gt;&lt;fieldset&gt;
    &lt;h1&gt;Saisie de l'identifiant de groupe&lt;/h1&gt;
    &lt;label for='groupe' id='label-groupe'&gt;Groupe&lt;/label&gt;
    &lt;input type='text' name='groupe' id='groupe' /&gt;
    &lt;span id='moyenne'&gt;
    &lt;/span&gt;
  &lt;/fieldset&gt;&lt;/form&gt;
  &lt;form action='' method='post' onsubmit='return notes(this)'&gt;
	&lt;fieldset id='f2' style='display:none'&gt;
		&lt;h1&gt;Saisie des notes&lt;/h1&gt;
		&lt;ul id='u'&gt;&lt;/ul&gt;
		&lt;input type='submit' value='Envoyer' /&gt;
	&lt;/fieldset&gt;
  &lt;/form&gt;
&lt;/body&gt;&lt;/html&gt;
</pre></div>
<div class="documents-joints">

<a href='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?action=acceder_document&amp;arg=846&amp;cle=2063e243a0b92b271902aca221cfb7da113825d7&amp;file=distant%2FVCS%2FLI355%2FTD%2F10%2Fdouble_script.html' type='text/html' title='HTML - - double_script.html'><img src='Ajouts/Licence_pacs_esj6_2013_2014/local/cache-vignettes/L52xH52/html-df9ff-5c7ff.png' width='52' height='52' style='height:52px;width:52px;' alt='' class='spip_logos' /></a><br />double_script.html

</div>


<div style='text-align:right' id='s1435'>
Fichier &agrave; cr&eacute;er&nbsp;: <tt>ajax.js groupe.js get_groupe.php presenter.js verifier.js notes.js entrer_notes.php moyenne.js</tt><br />
</div>




</div><div id='pied' class='pied_page'><ul>
<li><a href="http://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fwww-licence.ufr-info-p6.jussieu.fr%2Flmd%2Flicence%2F2013%2Fue%2Fpacs-2014fev%2FFormulaires-en-AJAX"
	rel='noindex nofollow'
	class='validation-css'
	title='v&eacute;rifier la validit&eacute; CSS 2.1'>Valid CSS 2.1</a></li>
<li><a href='http://validator.w3.org/check?uri=https%3A%2F%2Fwww-licence.ufr-info-p6.jussieu.fr%2Flmd%2Flicence%2F2013%2Fue%2Fpacs-2014fev%2FFormulaires-en-AJAX'
	class='validation-xml'
	rel='noindex nofollow'
	title='v&eacute;rifier la validit&eacute; XHTML Baisc 1.1'>Valid XHTML Basic 1.1</a></li>
<li><a href='http://www.contentquality.com/Default.asp?Url1=https%3A%2F%2Fwww-licence.ufr-info-p6.jussieu.fr%2Flmd%2Flicence%2F2013%2Fue%2Fpacs-2014fev%2FFormulaires-en-AJAX&amp;rptmode=2'
	 class='validation-wcag'
	title='v&eacute;rifier la validit&eacute; WCAG 2.0 AAA'>Triple-A conformance Web Content Accessibility Guidelines 2.0</a></li>
<li class='date-publi'>
Calcul&eacute; le 13 mai 2014 &agrave; 19h43min<br />
par 
<a href='https://www-licence.ufr-info-p6.jussieu.fr/lmd/licence/2013/ue/pacs-2014fev/spip.php?page=auteur&amp;id_auteur=1&amp;sujet=Signaler%20un%20souci%20technique%20avec%20le%20site%20PACS%202013%202014' 
	rel='noindex nofollow'
	title='Signaler un souci technique avec le site'>DidacSPIP</a><br />
Universit&eacute; Pierre et Marie Curie
</li>
<li><a href='http://validator.w3.org/mobile/check?docAddr=https%3A%2F%2Fwww-licence.ufr-info-p6.jussieu.fr%2Flmd%2Flicence%2F2013%2Fue%2Fpacs-2014fev%2FFormulaires-en-AJAX'
	class='mobile-ok'
	rel='noindex nofollow'
	title='v&eacute;rifier la validit&eacute; Mobile OK'>Mobile OK</a></li>
<li><a href='http://www.spip.net'
	class='reference-spip'
	title='Visiter SPIP'>SPIP</a></li>
<li><a href="http://prefetch.validatorsearch.verisignlabs.com"
	rel='noindex nofollow'
	title='voir http://validatorsearch.verisignlabs.com/'></a></li>
</ul></div></div></body>
</html>
